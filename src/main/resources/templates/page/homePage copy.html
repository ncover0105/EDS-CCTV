<!DOCTYPE html>
<html lang="ko"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <title th:text="${title}">EDS</title>
    <script src="/js/footer.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <!-- <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=66sw7wk0ye&callback=initMap"></script> -->
    <!-- OpenLayers 라이브러리 (필수) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.4.0/ol.css" />
    <script src="https://cdn.jsdelivr.net/npm/ol@7.4.0/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.1.2/adapter.min.js"></script> -->
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/gh/meetecho/janus-gateway/html/demos/janus.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/janus-gateway@latest/dist/janus.js"></script> -->
    <script src="js/module/janus.js"></script>

    <!-- 서버 데이터를 JavaScript로 전달 -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        var cameras = /*[[${cameras}]]*/ [];
        var mapApiKey = /*[[${mapApiKey}]]*/ "";
        // var speakerList = /*[[${speakerList}]]*/ [];
        /*]]>*/
    </script>
    <script>
        window.VWORLD_API_KEY = /*[[${mapApiKey}]]*/ "";
    </script>
    <script src="/js/jsmpeg.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/jsmpeg@0.2.1/jsmpeg.min.js"></script> -->
    <script src="/js/scripts.js"></script>
    <script src="/js/module/map.js"></script>
    <script src="/js/module/weather.js"></script>
    <script src="/js/module/cctv_layout.js"></script>
    <script src="/js/module/cctv_janus.js"></script>
    <script src="/js/module/mqtt.js"></script>
    <script src="/js/module/logs.js"></script>
    <script src="/js/ui/modal_broadcast.js"></script>
    <script src="/js/ui/modal_speaker_setting.js"></script>
    <!-- <script th:src="@{/js/btype_action_modal.js}"></script> -->
</head>
<body>
    <!-- Main -->
    <div class="container-fluid" layout:fragment="content">
        <div class="row h-100 flex-wrap">
            <!-- 좌측: CCTV 패널-->
            <div class="col-md-12 col-xxl-9 d-flex flex-column h-auto">
                <!-- <div class="p-3" style="flex: 0 0 auto;"> -->
                <div class="flex-shrink-0">
                    <div class="d-flex p-3 align-items-center justify-content-between shadow-lg rounded-3 flex-nowrap gap-3 bg-dark-lighter">
                        <div class="d-flex align-items-center gap-3 text-nowrap">
                            <div class="dropdown">
                                <button class="btn-apple-light dropdown-toggle gap-2" type="button" id="viewDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-grid-3x3-gap-fill me-1"></i>
                                    <span class="d-none d-md-inline">레이아웃</span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-dark mt-2" aria-labelledby="viewDropdown">
                                    <li><a class="dropdown-item" href="#" data-layout="4">2x2</a></li>
                                    <li><a class="dropdown-item" href="#" data-layout="9">3x3</a></li>
                                    <li><a class="dropdown-item" href="#" data-layout="16">4x4</a></li>
                                </ul>
                            </div>

                            <button class="btn-apple-light gap-2" id="mapBtn">
                                <i class="bi bi-geo-alt-fill"></i>
                                <span class="d-none d-md-inline">지도화면</span>
                            </button>

                            <button class="btn-apple-light gap-2" id="speakerList" data-bs-toggle="modal" data-bs-target="#speaker_setting_modal">
                                <i class="bi bi-list"></i>
                                <span class="d-none d-md-inline">스피커 정보</span>
                            </button>
    
                            <button type="button" data-bs-toggle="modal" data-bs-target="#broadcast_modal" class="btn-apple-danger gap-2">
                                <i class="bi bi-exclamation-triangle"></i>
                                <span class="d-none d-md-inline">수동발령</span>
                            </button>

                            <button type="button" data-bs-toggle="modal" data-bs-target="#btype_action_modal" class="btn-apple-warning gap-2">
                                <i class="bi bi-arrow-up-right-square"></i>
                                <span class="d-none d-md-inline">스피커 테스트</span>
                            </button>

                        </div>
                        <div class="d-none d-md-block">
                            <div class="current-time py-1 px-3 text-center text-nowrap">
                                <span id="currentDate"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- <div class="p-3 min-h-0" style="flex: 1 1 auto;"> -->
                <div class="py-3 flex-grow-1 d-flex flex-column">
                    <div class="card flex-grow-1 bg-transparent">
                        <div class="card-body p-0 h-100 justify-content-center align-content-center">
                            <div id="cctv-container"class="h-100">
                                <!-- CCTV 피드 동적 생성 -->
                            </div>
    
                            <!-- GPS Map-->
                            <div id="map-container" class="d-none">
                                <div class="map-controls">
                                    <div class="map-control-btn" id="refreshMap">
                                        <i class="bi bi-arrow-clockwise me-1"></i>
                                        새로고침
                                    </div>
                                </div>
                                <div class="camera-status-summary">
                                    <div class="summary-title">
                                        <i class="bi bi-speaker-fill me-2"></i>
                                        스피커 상태
                                    </div>
                                    <div class="status-count">
                                        <span class="count-label">온라인</span>
                                        <span class="count-number camera-online" id="onlineCount">0</span>
                                    </div>
                                    <div class="status-count">
                                        <span class="count-label">오프라인</span>
                                        <span class="count-number camera-offline" id="offlineCount">0</span>
                                    </div>
                                    <div class="status-count">
                                        <span class="count-label">점검중</span>
                                        <span class="count-number camera-maintenance" id="maintenanceCount">0</span>
                                    </div>
                                </div>
                                <div id="map">
                                    <div id="mapTooltip" class="map-tooltip"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 우측: 정보 패널 -->
            <div class="col-md-12 col-xxl-3 sidebar d-flex flex-column gap-3 pt-0 h-100">
                <div class="d-flex flex-column gap-3 flex-grow-1">
                    <!-- 출입 기록 패널 -->
                    <div class="sidebar-panel" id="logPanel">
                        <div class="panel-header">
                            <span>출입기록</span>
                            <span id="logCount" class="badge info">0건</span>
                        </div>
                        <div id="logContainer" class="panel-scroll">
                        </div>
                        <div id="emptyLogMessage"
                            class="d-none d-flex flex-column align-items-center justify-content-center text-center flex-grow-1">
                            <i class="bi bi-exclamation-circle mb-2 fs-3 text-muted"></i>
                            <p class="mb-0 small text-muted">출입 기록이 없습니다.</p>
                        </div>
                    </div>
                    
                    <div class="sidebar-panel" id="speakerPanel">
                        <div class="panel-header">
                            <span>스피커 상태</span>
                        </div>
                        <div id="speakerContainer" class="panel-scroll">
                        </div>
                        <div id="emptySpeakerMessage"
                            class="d-none d-flex flex-column align-items-center justify-content-center text-center flex-grow-1">
                            <i class="bi bi-exclamation-circle mb-2 fs-3 text-muted"></i>
                            <p class="mb-0 small text-muted">스피커 상태 정보가 없습니다.</p>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-panel">
                    <div class="panel-header">
                        <span>현재 날씨</span>
                        <div class="map-toggle">
                            <input type="radio" class="btn-check" name="map_type" id="radar" autocomplete="off" checked>
                            <label class="btn px-2" for="radar">
                                <i class="fa-solid fa-broadcast-tower me-1"></i>레이더
                            </label>
                        
                            <input type="radio" class="btn-check" name="map_type" id="satellite" autocomplete="off">
                            <label class="btn px-2" for="satellite">
                                <i class="fa-solid fa-satellite me-1"></i>위성
                            </label>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="row d-flex align-items-center">
                            <!-- 좌측: 날씨 요약 정보 -->
                            <div class="col-12 col-md-6">
                                <!-- 현재 날씨 아이콘 및 온도 -->
                                <div class="weather-main">
                                    <img id="weather_icon" alt="Weather icon" class="weather-icon" />
                                    <div class="weather-info text-center">
                                        <div id="temperature" class="weather-temperature">-</div>
                                        <div id="weather" class="weather-description">-</div>
                                    </div>
                                </div>
                                <!-- 날씨 세부 정보 그리드 -->
                                <div class="weather-grid">
                                    <div class="weather-item">
                                        <span id="rainfall"></span>
                                        <label class="form-label fs-8">강수량</label>
                                    </div>
                                    <div class="weather-item">
                                        <span id="humidity"></span>
                                        <label class="form-label fs-8">습도</label>
                                    </div>
                                    <div class="weather-item">
                                        <span id="windSpeed"></span>
                                        <label class="form-label fs-8">풍속</label>
                                    </div>
                                    <div class="weather-item">
                                        <span id="windDirection"></span>
                                        <label class="form-label fs-8">
                                            <i class="fa-solid fa-location-arrow text-primary me-1"></i>풍향
                                        </label>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- 우측: 레이더 / 위성 지도 -->
                            <div class="col-12 col-md-6">
                                <!-- 레이더 지도 -->
                                <div class="weather-map position-relative" id="radar-map">
                                    <div id="loadingSpinnerRadar" class="d-flex justify-content-center align-items-center flex-column position-absolute w-100 h-100">
                                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                                        <div class="mt-2 small">레이더 로딩중...</div>
                                    </div>
                                    <img id="radarImg" class="d-none w-100" alt="레이더 지도">
                                </div>
                        
                                <!-- 위성 지도 -->
                                <div class="weather-map d-none position-relative" id="satellite-map">
                                    <div id="loadingSpinnerSatellite" class="d-flex justify-content-center align-items-center flex-column position-absolute w-100 h-100">
                                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                                        <div class="mt-2 small">위성 로딩중...</div>
                                    </div>
                                    <img id="satelliteImg" class="d-none w-100" alt="위성 지도">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-panel">
                    <div class="panel-header">
                        <span>대기질 정보</span>
                    </div>
                    <div class="panel-content">
                        <div class="air-quality-main">
                            <div class="air-quality-item">
                                <div class="air-quality-label">미세먼지(PM10)</div>
                                <div class="air-quality-value" id="pm10Value">--</div>
                                <div class="air-quality-grade" id="pm10Grade">--</div>
                            </div>
                            <div class="air-quality-item">
                                <div class="air-quality-label">초미세먼지(PM2.5)</div>
                                <div class="air-quality-value" id="pm25Value">--</div>
                                <div class="air-quality-grade" id="pm25Grade">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-custom d-none">
            <div th:replace="~{fragments/footer :: footerFragment}"></div>
        </div>

        <div th:replace="~{fragments/modal/broadcast_modal :: #broadcast_modal}"></div>

        <!-- 전체화면 뷰 -->
        <div id="fullscreenView" class="fullscreen-view d-none">
            <button id="closefullScreen" class="close-fullscreen">
                <i class="bi bi-x-lg"></i>
            </button>
            <div class="fullscreen-content">
            </div>
        </div>
        
        <!-- 알림 -->
        <div class="notification notification-danger" id="customNotification">
            <div class="notification-icon">
                <i class="bi bi-exclamation-triangle-fill"></i>
            </div>
            <div class="notification-content">
                <div id="notification-title" class="notification-title"></div>
                <div id="notification-message" class="notification-message"></div>
            </div>
        </div>
        <!-- <script src="/js/notimodal.js"></script> -->
    </div>
</body>
</html>